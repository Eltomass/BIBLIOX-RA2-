DATOS PARA EL INFORME DE EVALUACIÓN PARCIAL N°3 - OBSERVABILIDAD

================================================================================
1. INTRODUCCIÓN Y CONTEXTO
================================================================================
Proyecto: BiblioX - Sistema de Gestión de Biblioteca con Agente Funcional
Objetivo RA3: Implementar un sistema completo de observabilidad, monitoreo y seguridad para el agente.
Tecnologías: Python, FastAPI, LangChain, Streamlit, Plotly, Psutil.
Modelo LLM: qwen2.5-coder:7b (Local vía Ollama).

================================================================================
2. IMPLEMENTACIÓN DE MÉTRICAS (IE1 y IE2)
================================================================================
Archivo: backend/src/monitoring/metrics.py
Clase: MetricsCollector

Métricas Implementadas:
1. Precisión y Errores (IE1):
   - Tasa de éxito: (Requests exitosos / Total requests) * 100
   - Tasa de error: (Requests fallidos / Total requests) * 100
   - Conteo de errores por tipo y componente.
   - Herramientas más utilizadas y su tasa de éxito individual.

2. Latencia y Recursos (IE2):
   - Latencia End-to-End: Tiempo total desde recepción del request hasta respuesta.
   - Latencia por Componente: Desglose de tiempo en Agente, Herramientas, RAG y Memoria.
   - Percentiles: P50 (Mediana), P95 (Peores casos comunes), P99 (Casos extremos).
   - Recursos del Sistema: Uso de CPU (%) y Memoria RAM (MB) capturados al inicio y fin de cada request usando `psutil`.

Justificación Técnica:
Se utilizó un diseño Singleton para `MetricsCollector` para garantizar una única fuente de verdad de métricas en toda la aplicación, con manejo de concurrencia mediante `threading.Lock`.

================================================================================
3. SISTEMA DE LOGGING Y TRAZABILIDAD (IE3)
================================================================================
Archivo: backend/src/monitoring/logger.py
Clase: StructuredLogger

Características Clave:
- Formato JSON: Logs estructurados para fácil parsing y análisis automatizado.
- Trace ID: Identificador único (8 caracteres) generado al inicio de cada request que permite correlacionar todos los logs de una misma transacción.
- Niveles de Log: DEBUG, INFO, WARNING, ERROR.
- Eventos Específicos:
  * request_start / request_end
  * agent_thought (Razonamiento)
  * tool_execution (Acción)
  * tool_observation (Resultado)
  * error_captured

Ejemplo de Log Generado:
{
  "timestamp": "2024-11-24T15:30:00.123",
  "level": "INFO",
  "event": "tool_execution",
  "trace_id": "a1b2c3d4",
  "data": {
    "tool": "search_book",
    "input": "Python",
    "latency": 0.45,
    "success": true
  }
}

================================================================================
4. DASHBOARD DE MONITOREO (IE5)
================================================================================
Archivo: backend/streamlit_dashboard.py
Tecnología: Streamlit + Plotly

Secciones del Dashboard:
1. KPIs Principales: Métricas de alto nivel (Total requests, Tasa de éxito, Latencia promedio, Errores).
2. Análisis de Latencia: Histograma de distribución y gráfico de barras de percentiles.
3. Uso de Herramientas: Gráfico de torta (distribución) y tabla detallada de rendimiento por herramienta.
4. Uso de Recursos: Medidores (Gauges) para CPU y Memoria RAM promedio.
5. Errores y Anomalías: Tabla de últimos errores y detección automática de latencias anómalas (> 2x promedio).
6. Logs y Trazabilidad: Visor interactivo de los últimos 10 requests con detalle expandible del flujo ReAct.

Diseño: Interfaz moderna con animaciones CSS, sin emojis excesivos, modo oscuro/claro automático.

================================================================================
5. SEGURIDAD Y ÉTICA (IE6)
================================================================================
Archivo: backend/src/monitoring/security.py
Clase: SecurityValidator, RateLimiter

Protocolos Implementados:
1. Detección de Prompt Injection:
   - Bloqueo de patrones maliciosos como "ignore previous instructions", "system override", etc.
   - Validación antes de procesar cualquier input del usuario.

2. Sanitización de PII (Información Personal Identificable):
   - Eliminación automática de emails, teléfonos y RUTs en los logs.
   - Garantiza privacidad de datos en el sistema de observabilidad.

3. Rate Limiting:
   - Límite de 20 requests por minuto por usuario.
   - Prevención de ataques de denegación de servicio (DoS) y abuso del LLM.

================================================================================
6. ANÁLISIS DE DATOS Y PATRONES (IE4)
================================================================================
Patrones Detectados (Basado en pruebas):
- Las búsquedas de libros (`search_book`) son la operación más frecuente (~40%).
- La latencia promedio aumenta linealmente con la complejidad del plan generado.
- El uso de memoria es estable, pero tiene picos durante la generación de respuestas largas del LLM.

Anomalías Identificadas:
- Requests que requieren más de 3 pasos de razonamiento tienden a superar el P95 de latencia.
- Errores de "Tool not found" ocurren si el LLM alucina nombres de herramientas (mitigado con validación).

================================================================================
7. RECOMENDACIONES DE OPTIMIZACIÓN (IE7)
================================================================================
1. Implementar Caché Semántico:
   - Problema: Consultas repetidas consumen recursos de inferencia.
   - Solución: Usar Redis para cachear respuestas a preguntas frecuentes.
   - Impacto estimado: Reducción de latencia en un 40% para consultas comunes.

2. Optimización de Contexto RAG:
   - Problema: Recuperar demasiados documentos irrelevantes aumenta el ruido y latencia.
   - Solución: Ajustar `k` (número de documentos) dinámicamente según la especificidad de la query.
   - Impacto estimado: Mejora en precisión y reducción de tokens de entrada.

3. Compresión de Logs:
   - Problema: El archivo `agent.log` crece indefinidamente.
   - Solución: Implementar rotación de logs diaria y compresión gzip.
   - Impacto estimado: Ahorro de espacio en disco del 90%.

================================================================================
8. CONCLUSIÓN
================================================================================
El sistema implementado cumple con todos los requisitos de la Evaluación Parcial N°3, proporcionando una solución robusta para la observabilidad del agente. La combinación de métricas detalladas, logging estructurado y un dashboard visual permite una gestión proactiva del rendimiento y la seguridad del sistema.
